<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Osu! Iraq Leaderboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: auto; }
h1 { text-align: center; }
table { border-collapse: collapse; width: 100%; margin-top: 10px; }
th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
th { background: #f4f4f4; cursor: pointer; }
img.avatar { width: 32px; height: 32px; border-radius: 50%; vertical-align: middle; margin-right: 8px; }
.small { font-size: .9em; color: #666; }
button.tab { padding: 10px 20px; margin-right: 5px; cursor: pointer; }
button.tab.active { background-color: #4CAF50; color: white; }
.pagination { margin-top: 10px; }
.pagination button { margin: 2px; padding: 5px 10px; }
.highlight { background-color: #fff9c4; } /* highlight local stars */
</style>
</head>
<body>

<h1>Osu! Iraq Leaderboard</h1>
<p class="small">Auto-updated via GitHub Actions. Using official osu! API v2.</p>
<p>Last update: <span id="updated">-</span></p>

<div id="tabs">
  <button class="tab active" data-type="pp">PP</button>
  <button class="tab" data-type="accuracy">Accuracy</button>
  <button class="tab" data-type="play_count">Play Count</button>
  <button class="tab" data-type="level">Level</button>
</div>

<table id="table" aria-live="polite">
<thead>
<tr><th>#</th><th>User</th><th>Global Rank</th><th id="metric-header">PP</th></tr>
</thead>
<tbody></tbody>
</table>

<div class="pagination" id="pagination"></div>

<script>
let leaderboard = [];
let currentTab = 'pp';
let currentPage = 1;
const pageSize = 50;

async function loadLeaderboard() {
  try {
    const res = await fetch('leaderboard.json', {cache: "no-store"});
    const json = await res.json();
    leaderboard = json.items || [];
    document.getElementById('updated').textContent =
      json.updated_at ? new Date(json.updated_at).toLocaleString() : '-';
    renderTable();
  } catch (err) {
    document.querySelector('#table tbody').innerHTML = `<tr><td colspan="4">Error: ${err.message}</td></tr>`;
  }
}

function renderTable() {
  const tbody = document.querySelector('#table tbody');
  tbody.innerHTML = '';
  const metricHeader = document.getElementById('metric-header');

  let sorted = [...leaderboard];
  switch(currentTab) {
    case 'pp':
      metricHeader.textContent = 'PP';
      sorted.sort((a,b) => (b.pp || 0) - (a.pp || 0));
      break;
    case 'accuracy':
      metricHeader.textContent = 'Accuracy %';
      sorted.sort((a,b) => (b.accuracy || 0) - (a.accuracy || 0));
      break;
    case 'play_count':
      metricHeader.textContent = 'Plays';
      sorted.sort((a,b) => (b.play_count || 0) - (a.play_count || 0));
      break;
    case 'level':
      metricHeader.textContent = 'Level';
      sorted.sort((a,b) => (b.level || 0) - (a.level || 0));
      break;
  }

  const start = (currentPage - 1) * pageSize;
  const pageItems = sorted.slice(start, start + pageSize);

  pageItems.forEach((u, i) => {
    const tr = document.createElement('tr');
    if(u.country_code === 'IQ') tr.classList.add('highlight');
    tr.innerHTML = `
      <td>${start + i + 1}</td>
      <td><img src="${u.avatar_url}" class="avatar"><a href="https://osu.ppy.sh/users/${u.user_id}" target="_blank">${u.username}</a></td>
      <td>#${u.rank ?? '-'}</td>
      <td>${currentTab==='pp' ? u.pp : currentTab==='accuracy' ? (u.accuracy?.toFixed(2) || '-') :
          currentTab==='play_count' ? u.play_count : u.level || '-'}</td>
    `;
    tbody.appendChild(tr);
  });

  renderPagination(sorted.length);
}

function renderPagination(total) {
  const pagination = document.getElementById('pagination');
  pagination.innerHTML = '';
  const totalPages = Math.ceil(total / pageSize);
  for(let i=1;i<=totalPages;i++){
    const btn = document.createElement('button');
    btn.textContent = i;
    if(i===currentPage) btn.disabled=true;
    btn.onclick = ()=>{currentPage=i; renderTable();};
    pagination.appendChild(btn);
  }
}

document.querySelectorAll('button.tab').forEach(btn=>{
  btn.onclick = ()=>{
    document.querySelectorAll('button.tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    currentTab = btn.getAttribute('data-type');
    currentPage = 1;
    renderTable();
  };
});

loadLeaderboard();
setInterval(loadLeaderboard, 60000);
</script>

</body>
</html>
